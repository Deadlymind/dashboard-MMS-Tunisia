from rest_framework import serializers
from .models import Client, ClientObjetSocial

class ClientSerializer(serializers.ModelSerializer):
    class Meta:
        model = Client
        fields = "__all__"
        read_only_fields = ("id","created_at","updated_at")
        extra_kwargs = {"code": {"required": False, "allow_blank": True}}

    def create(self, validated_data):
        # no code field in the create form; generate after insert
        code_in = validated_data.get("code")
        obj = super().create(validated_data)
        if not code_in:
            obj.code = f"CL{obj.id:04d}"
            obj.save(update_fields=["code"])
        return obj

class ClientObjetSocialSerializer(serializers.ModelSerializer):
    code = serializers.SerializerMethodField()
    class Meta:
        model = ClientObjetSocial
        fields = ["id","code","nomination","agrement","client"]
        read_only_fields = ["id","code","client"]
    def get_code(self, obj): return obj.id
